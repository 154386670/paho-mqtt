# MQTT 工作原理

## MQTT 协议实现方式

![img](figures/mqtt_principle.png) 

- 实现MQTT协议需要：客户端和服务器端。
- MQTT协议中有三种身份：发布者（Publish）、代理（Broker）（服务器）、订阅者（Subscribe）。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。
- MQTT传输的消息分为：主题（Topic）和负载（payload）两部分：
	- Topic，可以理解为消息的类型，订阅者订阅（Subscribe）后，就会收到该主题的消息内容（payload）。
	- payload，可以理解为消息的内容，是指订阅者具体要使用的内容。

## 网络运输与应用消息 

- `MQTT`会构建底层网络传输：它将建立客户端到服务器的连接，提供两者之间的一个有序的、无损的、基于字节流的双向传输。
- 当应用数据通过`MQTT`网络发送时，`MQTT`会把与之相关的服务质量（QoS）和主题名（Topic）相关连。

## MQTT 客户端

一个使用MQTT协议的应用程序或者设备，它总是建立到服务器的网络连接。客户端可以：

- 其他客户端可能会订阅的信息
- 其它客户端发布的消息
- 或删除应用程序的消息
- 与服务器连接

## MQTT 服务器

MQTT服务器以称为“消息代理”（Broker），可以是一个应用程序或一台设备。它是位于消息发布者和订阅者之间，它可以：

- 接受来自客户的网络连接
- 接受客户发布的应用信息
- 处理来自客户端的订阅和退订请求
- 向订阅的客户转发应用程序消息

## QTT 协议中的订阅、主题、会话

- 订阅（Subscription）
订阅包含主题筛选器（Topic Filter）和最大服务质量（QoS）。订阅会与一个会话（Session）关联。一个会话可以包含多个订阅。每一个会话中的每个订阅都有一个不同的主题筛选器。

- 会话（Session）
每个客户端与服务器建立连接后就是一个会话，客户端和服务器之间有状态交互。会话存在于一个网络之间，也可能在客户端和服务器之间跨越多个连续的网络连接。

- 主题名（Topic Name）
连接到一个应用程序消息的标签，该标签与服务器的订阅相匹配。服务器会将消息发送给订阅所匹配标签的每个客户端。

- 主题筛选器（Topic Filter）
一个对主题名通配符筛选器，在订阅表达式中使用，表示订阅所匹配到的多个主题。

- 负载（Payload）
消息订阅者所具体接收的内容。

- 应用消息 Application Message
MQTT协议通过网络传输应用数据。应用消息通过MQTT传输时，它们有关联的服务质量（QoS）和主题（Topic）。

- 控制报文 MQTT Control Packet
通过网络连接发送的信息数据包。MQTT规范定义了十四种不同类型的控制报文，其中一个（PUBLISH报文）用于传输应用消息。

## MQTT 协议中的方法

MQTT协议中定义了一些方法（也被称为动作）， 来于表示对确定资源所进行操作。 这个资源可以代表预先存在的数据或动态生成数据，这取决于服务器的实现。通常来说，资源指服务器上的文件或输出。

- Connect，等待与服务器建立连接。
- Disconnect，等待MQTT客户端完成所做的工作，并与服务器断开TCP/IP会话。
- Subscribe，等待完成订阅。
- UnSubscribe，等待服务器取消客户端的一个或多个topics订阅。
- Publish，MQTT客户端发送消息请求，发送完成后返回应用程序线程。